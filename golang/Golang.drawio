<mxfile host="drawio-plugin" modified="2023-11-24T02:41:42.363Z" agent="5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36" etag="FzrnfbuCVyjqSTrEPYuW" version="20.5.3" type="embed"><diagram name="Page-1" id="LpzNjsjSlAp0MfS5wQbg"><mxGraphModel dx="1806" dy="581" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1100" math="0" shadow="0"><root><mxCell id="0"/><mxCell id="1" parent="0"/><mxCell id="14" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=18;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1"><mxGeometry y="10" width="930" height="1040" as="geometry"/></mxCell><mxCell id="8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=24;" parent="1" source="3" target="7" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="3" value="&lt;b&gt;&lt;font style=&quot;font-size: 24px;&quot;&gt;map定位key过程&lt;/font&gt;&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;" parent="1" vertex="1"><mxGeometry x="260" y="50" width="210" height="40" as="geometry"/></mxCell><mxCell id="12" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.448;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=24;" parent="1" source="7" target="11" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="7" value="&lt;b&gt;h:= alg.hash(key,uintptr(h.hash0))&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=24;" parent="1" vertex="1"><mxGeometry x="160" y="180" width="410" height="40" as="geometry"/></mxCell><mxCell id="9" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;&lt;b&gt;首先根据key计算hash值&lt;/b&gt;&lt;/font&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=24;" parent="1" vertex="1"><mxGeometry x="370" y="120" width="220" height="40" as="geometry"/></mxCell><mxCell id="16" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;exitX=0.462;exitY=1.043;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="11" target="15" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="11" value="&lt;b&gt;m := uintptr(1)&amp;lt;&amp;lt;h.B -1&lt;br&gt;b := (*bmap)(add(h.buckets,(hash&amp;amp;m)*uintptr(t.bucketsize)))&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=24;" parent="1" vertex="1"><mxGeometry x="45" y="330" width="710" height="70" as="geometry"/></mxCell><mxCell id="13" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;&lt;b&gt;根据B算出buckets的个数后，再计算bucket的位置&lt;/b&gt;&lt;/font&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=24;" parent="1" vertex="1"><mxGeometry x="365" y="260" width="430" height="40" as="geometry"/></mxCell><mxCell id="18" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;" parent="1" source="15" target="17" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="20" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;" parent="1" source="15" target="19" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="15" value="&lt;b&gt;判断当前map是否扩容了？&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="250" y="470" width="240" height="40" as="geometry"/></mxCell><mxCell id="28" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;entryX=0.276;entryY=-0.025;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="17" target="27" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="17" value="&lt;b&gt;判断是否是同size扩容&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="30" y="590" width="200" height="40" as="geometry"/></mxCell><mxCell id="26" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;" parent="1" source="19" target="25" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="19" value="&lt;b&gt;top := uint8(hash &amp;gt;&amp;gt; (sys.PtrSize*8)-8)&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="425" y="610" width="350" height="40" as="geometry"/></mxCell><mxCell id="21" value="&lt;b&gt;Yes&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="175" y="510" width="50" height="40" as="geometry"/></mxCell><mxCell id="22" value="&lt;b&gt;No&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="380" y="520" width="50" height="40" as="geometry"/></mxCell><mxCell id="23" value="&lt;b&gt;计算top值&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="500" y="520" width="110" height="40" as="geometry"/></mxCell><mxCell id="25" value="&lt;b&gt;for {&lt;br&gt;// 遍历循环来查找&lt;br&gt;}&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="530" y="720" width="160" height="80" as="geometry"/></mxCell><mxCell id="31" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;exitX=0.29;exitY=1.025;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="27" target="30" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="27" value="&lt;b&gt;oldb d:= (*bmap)(add(c,(hash&amp;amp;m)*uintptr(t.bucketsize)))&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="-10" y="760" width="500" height="40" as="geometry"/></mxCell><mxCell id="29" value="&lt;b&gt;若不是同size：m &amp;lt;&amp;lt; 1&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="140" y="680" width="200" height="40" as="geometry"/></mxCell><mxCell id="30" value="&lt;b&gt;if !evacuated(oldb) {&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#9;&lt;/span&gt;b = oldb&lt;br&gt;}&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="30" y="860" width="200" height="80" as="geometry"/></mxCell><mxCell id="32" value="&lt;b&gt;判断oldb是否搬迁到新bucket中&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" parent="1" vertex="1"><mxGeometry x="150" y="820" width="280" height="40" as="geometry"/></mxCell><mxCell id="33" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1"><mxGeometry x="10" y="1210" width="930" height="720" as="geometry"/></mxCell><mxCell id="36" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=24;" edge="1" parent="1" source="34" target="35"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="34" value="&lt;b&gt;&lt;font style=&quot;font-size: 24px;&quot;&gt;Map扩容&lt;/font&gt;&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;" vertex="1" parent="1"><mxGeometry x="380" y="1230" width="120" height="40" as="geometry"/></mxCell><mxCell id="39" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;" edge="1" parent="1" source="35" target="38"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="35" value="&lt;b&gt;1.map扩容有2种，等size和double size扩容&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=24;" vertex="1" parent="1"><mxGeometry x="190" y="1330" width="500" height="40" as="geometry"/></mxCell><mxCell id="37" value="&lt;b&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;判断是否触发扩容&lt;/font&gt;&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=24;" vertex="1" parent="1"><mxGeometry x="460" y="1280" width="140" height="40" as="geometry"/></mxCell><mxCell id="43" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;" edge="1" parent="1" source="38" target="41"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="44" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;" edge="1" parent="1" source="38" target="42"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="38" value="&lt;b&gt;&lt;font style=&quot;font-size: 24px;&quot;&gt;2.扩容的过程并不是在判断要扩容就发生的，&lt;br&gt;而是在插入，删除，更新等操作的时候移动bucket&lt;/font&gt;&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" vertex="1" parent="1"><mxGeometry x="160" y="1450" width="560" height="70" as="geometry"/></mxCell><mxCell id="40" value="&lt;b&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;每次一般只移动2个bucket&lt;/font&gt;&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" vertex="1" parent="1"><mxGeometry x="450" y="1400" width="190" height="40" as="geometry"/></mxCell><mxCell id="41" value="&lt;b&gt;&lt;font style=&quot;font-size: 18px;&quot;&gt;等size扩容相当于移动到新bucket&lt;/font&gt;&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=24;" vertex="1" parent="1"><mxGeometry x="80" y="1630" width="300" height="40" as="geometry"/></mxCell><mxCell id="42" value="&lt;b&gt;double size扩容的话，会B会+1，&lt;br&gt;重新计算老bucket位于新bucket的哪个位置&lt;/b&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=18;" vertex="1" parent="1"><mxGeometry x="450" y="1620" width="370" height="60" as="geometry"/></mxCell></root></mxGraphModel></diagram></mxfile>